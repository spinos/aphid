#include "Calculus.h"

namespace aphid {

namespace calc {

void legendreRule(int m, int n, float * v,
		const float * xi)
{
	int i, j;

	for ( i = 0; i < m; i++ ) {
		v[i+0*m] = 1.0;
	}

	for ( i = 0; i < m; i++ ) {
		v[i+1*m] = xi[i];
	}
	
	for ( j = 2; j <= n; j++ ) {
		for ( i = 0; i < m; i++ ) {
			v[i+j*m] = ( ( float ) ( 2 * j - 1 ) *  (xi[i]) * v[i+(j-1)*m]   
					 - ( float ) (     j - 1 ) *        v[i+(j-2)*m] ) 
					 / ( float ) (     j     );
		}
	}
}

float interpolate(int nknots, const float * yknots, int m, float x, float a, float b, float dx)
{
	int g = (x - a) / dx;
	if(g<1)
		return yknots[0];
	if(g>=m-1)
		return yknots[nknots-1];
		
	float movern =  ((float)m - 1.0) / ((float)nknots - 1);
	int n0 = g / movern;
	int n1 = n0 + 1;
	
	float alpha = (g - n0 * movern) / movern;
	return yknots[n0] * (1.f - alpha) + yknots[n1] * alpha;
}

float trapezIntegral(const float & a, const float & b, int m, const float * y)
{
	const float h = (b - a) / (m - 1);
	float c = h * .5f * (y[0] + y[m-1]);
	int i=1;
	for(;i<m-1;++i) {
		c += h * y[i];
	}
	return c;
}

/// 2 + 3 + 4 + 5 + 6
static const float GaussQuadratureWeight[20] = {
1.f, 1.f,
.555555556f, .888888889f, .555555556f,
.347854845f, .652145155f, .652145155f, .347854845f,
.236926885f, .478628670f, .568888889f, .478628670f, .236926885f,
.171324492f, .360761573f, .467913935f, .467913935f, .360761573f, .171324492f
};

static const float GaussQuadratureArgument[20] = {
-.577350269f, .577350269f,
-.774596669f, 0.f, .774596669f,
-.861136312f, -.339981044f, .339981044f, .861136312f,
-.906179846f, -.538469310f, 0.f, .538469310f, .906179846f,
-.932469514f, -.661209386f, -.238619186f, .238619186f, .661209386f, .932469514f
};

static const int GaussQuadratureNInd[7] = {
0, 0, 0, 
2,
5,
9,
14
};

void gaussQuadratureRule(int n, float * ci, float * xi)
{
	const int i0 = GaussQuadratureNInd[n];
	for(int i=0; i<n; ++i) {
		ci[i] = GaussQuadratureWeight[i0 + i];
		xi[i] = GaussQuadratureArgument[i0 + i];
	}
}

void tuple_next( int m1, int m2, int n, int *rank, int x[] )
{
  int i;
  int j;

  if ( m2 < m1 )
  {
    *rank = 0;
    return;
  }

  if ( *rank <= 0 )
  {
    for ( i = 0; i < n; i++ )
    {
      x[i] = m1;
    }
    *rank = 1;
  }
  else
  {
    *rank = *rank + 1;
    i = n - 1;

    for ( ; ; )
    {

      if ( x[i] < m2 )
      {
        x[i] = x[i] + 1;
        break;
      }

      x[i] = m1;

      if ( i == 0 )
      {
        *rank = 0;
        for ( j = 0; j < n; j++ )
        {
          x[j] = m1;
        }
        break;
      }
      i = i - 1;
    }
  }

  return;
}

float gaussQuadratureRuleIntegrate(int n, int m, const float * xi, const float * wi, const float * Y)
{
	int k = 0, dim;
	float result = 0.f;
	int * indx = new int[n];
	float w;
	
	for ( ; ; ) {
		tuple_next ( 1, m, n, &k, indx );

		if ( k == 0  ) {
		  break;
		}

		w = 1.0;
		for ( dim = 0; dim < n; dim++ ) {
		  w = w * wi[indx[dim]-1];
		}

		result = result + w * Y[lexIndex(n, m, indx, -1)];
		
	}
	
	delete[] indx;
	return result;
	
}

int lexIndex(int n, int m, int * x, int offset)
{
	int result = 0;
	int mm = 1;
	int i=0;
	for(;i<n;++i) {
		result += (x[i] + offset) * mm;
		mm *= m;
	}
	return result;
}

const float LegendrePolynomial::mV[1799] = {
 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, -1, -0.992188, -0.984375, -0.976562, -0.96875, -0.960938, -0.953125, -0.945312, -0.9375, -0.929688, -0.921875, -0.914062, -0.90625, -0.898438, -0.890625, -0.882812, -0.875, -0.867188, -0.859375, -0.851562, -0.84375, -0.835938, -0.828125, -0.820312, -0.8125, -0.804688, -0.796875, -0.789062, -0.78125, -0.773438, -0.765625, -0.757812, -0.75, -0.742188, -0.734375, -0.726562, -0.71875, -0.710938, -0.703125, -0.695312, -0.6875, -0.679688, -0.671875, -0.664062, -0.65625, -0.648438, -0.640625, -0.632812, -0.625, -0.617188, -0.609375, -0.601562, -0.59375, -0.585938, -0.578125, -0.570312, -0.5625, -0.554688, -0.546875, -0.539062, -0.53125, -0.523438, -0.515625, -0.507812, -0.5, -0.492188, -0.484375, -0.476562, -0.46875, -0.460938, -0.453125, -0.445312, -0.4375, -0.429688, -0.421875, -0.414062, -0.40625, -0.398438, -0.390625, -0.382812, -0.375, -0.367188, -0.359375, -0.351562, -0.34375, -0.335938, -0.328125, -0.320312, -0.3125, -0.304688, -0.296875, -0.289062, -0.28125, -0.273438, -0.265625, -0.257812, -0.25, -0.242188, -0.234375, -0.226562, -0.21875, -0.210938, -0.203125, -0.195312, -0.1875, -0.179688, -0.171875, -0.164062, -0.15625, -0.148438, -0.140625, -0.132812, -0.125, -0.117188, -0.109375, -0.101562, -0.09375, -0.0859375, -0.078125, -0.0703125, -0.0625, -0.0546875, -0.046875, -0.0390625, -0.03125, -0.0234375, -0.015625, -0.0078125, 0, 0.0078125, 0.015625, 0.0234375, 0.03125, 0.0390625, 0.046875, 0.0546875, 0.0625, 0.0703125, 0.078125, 0.0859375, 0.09375, 0.101562, 0.109375, 0.117188, 0.125, 0.132812, 0.140625, 0.148438, 0.15625, 0.164062, 0.171875, 0.179688, 0.1875, 0.195312, 0.203125, 0.210938, 0.21875, 0.226562, 0.234375, 0.242188, 0.25, 0.257812, 0.265625, 0.273438, 0.28125, 0.289062, 0.296875, 0.304688, 0.3125, 0.320312, 0.328125, 0.335938, 0.34375, 0.351562, 0.359375, 0.367188, 0.375, 0.382812, 0.390625, 0.398438, 0.40625, 0.414062, 0.421875, 0.429688, 0.4375, 0.445312, 0.453125, 0.460938, 0.46875, 0.476562, 0.484375, 0.492188, 0.5, 0.507812, 0.515625, 0.523438, 0.53125, 0.539062, 0.546875, 0.554688, 0.5625, 0.570312, 0.578125, 0.585938, 0.59375, 0.601562, 0.609375, 0.617188, 0.625, 0.632812, 0.640625, 0.648438, 0.65625, 0.664062, 0.671875, 0.679688, 0.6875, 0.695312, 0.703125, 0.710938, 0.71875, 0.726562, 0.734375, 0.742188, 0.75, 0.757812, 0.765625, 0.773438, 0.78125, 0.789062, 0.796875, 0.804688, 0.8125, 0.820312, 0.828125, 0.835938, 0.84375, 0.851562, 0.859375, 0.867188, 0.875, 0.882812, 0.890625, 0.898438, 0.90625, 0.914062, 0.921875, 0.929688, 0.9375, 0.945312, 0.953125, 0.960938, 0.96875, 0.976562, 0.984375, 0.992188, 1, 1, 0.976654, 0.953491, 0.930511, 0.907715, 0.885101, 0.862671, 0.840424, 0.818359, 0.796478, 0.77478, 0.753265, 0.731934, 0.710785, 0.689819, 0.669037, 0.648438, 0.628021, 0.607788, 0.587738, 0.567871, 0.548187, 0.528687, 0.509369, 0.490234, 0.471283, 0.452515, 0.433929, 0.415527, 0.397308, 0.379272, 0.36142, 0.34375, 0.326263, 0.30896, 0.29184, 0.274902, 0.258148, 0.241577, 0.225189, 0.208984, 0.192963, 0.177124, 0.161469, 0.145996, 0.130707, 0.115601, 0.100677, 0.0859375, 0.0713806, 0.0570068, 0.0428162, 0.0288086, 0.0149841, 0.00134277, -0.0121155, -0.0253906, -0.0384827, -0.0513916, -0.0641174, -0.0766602, -0.0890198, -0.101196, -0.11319, -0.125, -0.136627, -0.148071, -0.159332, -0.17041, -0.181305, -0.192017, -0.202545, -0.212891, -0.223053, -0.233032, -0.242828, -0.252441, -0.261871, -0.271118, -0.280182, -0.289062, -0.29776, -0.306274, -0.314606, -0.322754, -0.330719, -0.338501, -0.3461, -0.353516, -0.360748, -0.367798, -0.374664, -0.381348, -0.387848, -0.394165, -0.400299, -0.40625, -0.412018, -0.417603, -0.423004, -0.428223, -0.433258, -0.43811, -0.44278, -0.447266, -0.451569, -0.455688, -0.459625, -0.463379, -0.466949, -0.470337, -0.473541, -0.476562, -0.479401, -0.482056, -0.484528, -0.486816, -0.488922, -0.490845, -0.492584, -0.494141, -0.495514, -0.496704, -0.497711, -0.498535, -0.499176, -0.499634, -0.499908, -0.5, -0.499908, -0.499634, -0.499176, -0.498535, -0.497711, -0.496704, -0.495514, -0.494141, -0.492584, -0.490845, -0.488922, -0.486816, -0.484528, -0.482056, -0.479401, -0.476562, -0.473541, -0.470337, -0.466949, -0.463379, -0.459625, -0.455688, -0.451569, -0.447266, -0.44278, -0.43811, -0.433258, -0.428223, -0.423004, -0.417603, -0.412018, -0.40625, -0.400299, -0.394165, -0.387848, -0.381348, -0.374664, -0.367798, -0.360748, -0.353516, -0.3461, -0.338501, -0.330719, -0.322754, -0.314606, -0.306274, -0.29776, -0.289062, -0.280182, -0.271118, -0.261871, -0.252441, -0.242828, -0.233032, -0.223053, -0.212891, -0.202545, -0.192017, -0.181305, -0.17041, -0.159332, -0.148071, -0.136627, -0.125, -0.11319, -0.101196, -0.0890198, -0.0766602, -0.0641174, -0.0513916, -0.0384827, -0.0253906, -0.0121155, 0.00134277, 0.0149841, 0.0288086, 0.0428162, 0.0570068, 0.0713806, 0.0859375, 0.100677, 0.115601, 0.130707, 0.145996, 0.161469, 0.177124, 0.192963, 0.208984, 0.225189, 0.241577, 0.258148, 0.274902, 0.29184, 0.30896, 0.326263, 0.34375, 0.36142, 0.379272, 0.397308, 0.415527, 0.433929, 0.452515, 0.471283, 0.490234, 0.509369, 0.528687, 0.548187, 0.567871, 0.587738, 0.607788, 0.628021, 0.648438, 0.669037, 0.689819, 0.710785, 0.731934, 0.753265, 0.77478, 0.796478, 0.818359, 0.840424, 0.862671, 0.885101, 0.907715, 0.930511, 0.953491, 0.976654, 1, -1, -0.953582, -0.908072, -0.863463, -0.819748, -0.77692, -0.734972, -0.693897, -0.653687, -0.614335, -0.575834, -0.538178, -0.501358, -0.465368, -0.430201, -0.395849, -0.362305, -0.329562, -0.297613, -0.266451, -0.236069, -0.206459, -0.177614, -0.149528, -0.122192, -0.0956008, -0.069746, -0.0446208, -0.0202179, 0.00346971, 0.0264492, 0.0487278, 0.0703125, 0.0912106, 0.111429, 0.130975, 0.149857, 0.16808, 0.185652, 0.20258, 0.218872, 0.234535, 0.249575, 0.264, 0.277817, 0.291033, 0.303656, 0.315692, 0.327148, 0.338033, 0.348352, 0.358114, 0.367325, 0.375992, 0.384123, 0.391724, 0.398804, 0.405368, 0.411425, 0.416981, 0.422043, 0.426619, 0.430716, 0.43434, 0.4375, 0.440202, 0.442453, 0.444261, 0.445633, 0.446575, 0.447096, 0.447201, 0.446899, 0.446197, 0.445101, 0.443619, 0.441757, 0.439524, 0.436926, 0.43397, 0.430664, 0.427015, 0.423029, 0.418714, 0.414078, 0.409127, 0.403868, 0.398309, 0.392456, 0.386317, 0.3799, 0.373211, 0.366257, 0.359045, 0.351583, 0.343879, 0.335938, 0.327768, 0.319376, 0.31077, 0.301956, 0.292942, 0.283735, 0.274342, 0.264771, 0.255027, 0.245119, 0.235054, 0.224838, 0.21448, 0.203985, 0.193362, 0.182617, 0.171758, 0.160791, 0.149725, 0.138565, 0.12732, 0.115995, 0.1046, 0.0931396, 0.0816224, 0.070055, 0.0584447, 0.0467987, 0.0351241, 0.023428, 0.0117176, -0, -0.0117176, -0.023428, -0.0351241, -0.0467987, -0.0584447, -0.070055, -0.0816224, -0.0931396, -0.1046, -0.115995, -0.12732, -0.138565, -0.149725, -0.160791, -0.171758, -0.182617, -0.193362, -0.203985, -0.21448, -0.224838, -0.235054, -0.245119, -0.255027, -0.264771, -0.274342, -0.283735, -0.292942, -0.301956, -0.31077, -0.319376, -0.327768, -0.335938, -0.343879, -0.351583, -0.359045, -0.366257, -0.373211, -0.3799, -0.386317, -0.392456, -0.398309, -0.403868, -0.409127, -0.414078, -0.418714, -0.423029, -0.427015, -0.430664, -0.43397, -0.436926, -0.439524, -0.441757, -0.443619, -0.445101, -0.446197, -0.446899, -0.447201, -0.447096, -0.446575, -0.445633, -0.444261, -0.442453, -0.440202, -0.4375, -0.43434, -0.430716, -0.426619, -0.422043, -0.416981, -0.411425, -0.405368, -0.398804, -0.391724, -0.384123, -0.375992, -0.367325, -0.358114, -0.348352, -0.338033, -0.327148, -0.315692, -0.303656, -0.291033, -0.277817, -0.264, -0.249575, -0.234535, -0.218872, -0.20258, -0.185652, -0.16808, -0.149857, -0.130975, -0.111429, -0.0912106, -0.0703125, -0.0487278, -0.0264492, -0.00346971, 0.0202179, 0.0446208, 0.069746, 0.0956008, 0.122192, 0.149528, 0.177614, 0.206459, 0.236069, 0.266451, 0.297613, 0.329562, 0.362305, 0.395849, 0.430201, 0.465368, 0.501358, 0.538178, 0.575834, 0.614335, 0.653687, 0.693897, 0.734972, 0.77692, 0.819748, 0.863463, 0.908072, 0.953582, 1, 1, 0.92324, 0.849177, 0.777761, 0.708943, 0.642674, 0.578907, 0.517593, 0.458685, 0.402135, 0.347897, 0.295925, 0.246172, 0.198593, 0.153143, 0.109777, 0.0684509, 0.0291201, -0.00825879, -0.0437289, -0.0773331, -0.109114, -0.139113, -0.167373, -0.193933, -0.218837, -0.242123, -0.263832, -0.284004, -0.302678, -0.319892, -0.335686, -0.350098, -0.363164, -0.374924, -0.385413, -0.394668, -0.402726, -0.409622, -0.415391, -0.420069, -0.42369, -0.426288, -0.427898, -0.428552, -0.428284, -0.427127, -0.425112, -0.422272, -0.418637, -0.41424, -0.409111, -0.40328, -0.396777, -0.389631, -0.381873, -0.373529, -0.36463, -0.355203, -0.345274, -0.334873, -0.324025, -0.312756, -0.301094, -0.289062, -0.276688, -0.263995, -0.251008, -0.237751, -0.224247, -0.210521, -0.196594, -0.182489, -0.168229, -0.153835, -0.139329, -0.124731, -0.110061, -0.0953412, -0.0805897, -0.0658264, -0.0510702, -0.0363397, -0.0216531, -0.00702822, 0.00751761, 0.0219673, 0.0363043, 0.0505123, 0.0645755, 0.0784785, 0.0922061, 0.105744, 0.119077, 0.132192, 0.145076, 0.157715, 0.170096, 0.182208, 0.194038, 0.205574, 0.216807, 0.227724, 0.238315, 0.248571, 0.258482, 0.268039, 0.277233, 0.286055, 0.294498, 0.302553, 0.310214, 0.317474, 0.324327, 0.330765, 0.336784, 0.342379, 0.347544, 0.352275, 0.356568, 0.360418, 0.363824, 0.366781, 0.369288, 0.371342, 0.372941, 0.374085, 0.374771, 0.375, 0.374771, 0.374085, 0.372941, 0.371342, 0.369288, 0.366781, 0.363824, 0.360418, 0.356568, 0.352275, 0.347544, 0.342379, 0.336784, 0.330765, 0.324327, 0.317474, 0.310214, 0.302553, 0.294498, 0.286055, 0.277233, 0.268039, 0.258482, 0.248571, 0.238315, 0.227724, 0.216807, 0.205574, 0.194038, 0.182208, 0.170096, 0.157715, 0.145076, 0.132192, 0.119077, 0.105744, 0.0922061, 0.0784785, 0.0645755, 0.0505123, 0.0363043, 0.0219673, 0.00751761, -0.00702822, -0.0216531, -0.0363397, -0.0510702, -0.0658264, -0.0805897, -0.0953412, -0.110061, -0.124731, -0.139329, -0.153835, -0.168229, -0.182489, -0.196594, -0.210521, -0.224247, -0.237751, -0.251008, -0.263995, -0.276688, -0.289062, -0.301094, -0.312756, -0.324025, -0.334873, -0.345274, -0.355203, -0.36463, -0.373529, -0.381873, -0.389631, -0.396777, -0.40328, -0.409111, -0.41424, -0.418637, -0.422272, -0.425112, -0.427127, -0.428284, -0.428552, -0.427898, -0.426288, -0.42369, -0.420069, -0.415391, -0.409622, -0.402726, -0.394668, -0.385413, -0.374924, -0.363164, -0.350098, -0.335686, -0.319892, -0.302678, -0.284004, -0.263832, -0.242123, -0.218837, -0.193933, -0.167373, -0.139113, -0.109114, -0.0773331, -0.0437289, -0.00825879, 0.0291201, 0.0684509, 0.109777, 0.153143, 0.198593, 0.246172, 0.295925, 0.347897, 0.402135, 0.458685, 0.517593, 0.578907, 0.642674, 0.708943, 0.777761, 0.849177, 0.92324, 1, -1, -0.885983, -0.778178, -0.676387, -0.580421, -0.49009, -0.40521, -0.3256, -0.251082, -0.18148, -0.116625, -0.056347, -0.00048213, 0.0511315, 0.0986524, 0.142236, 0.182034, 0.218195, 0.250866, 0.280189, 0.306305, 0.329349, 0.349457, 0.366758, 0.381382, 0.393452, 0.403092, 0.410421, 0.415555, 0.418608, 0.419692, 0.418915, 0.416382, 0.412197, 0.406459, 0.399268, 0.390717, 0.380899, 0.369906, 0.357823, 0.344737, 0.33073, 0.315883, 0.300272, 0.283974, 0.267062, 0.249606, 0.231676, 0.213337, 0.194654, 0.175688, 0.156499, 0.137146, 0.117682, 0.0981618, 0.0786367, 0.0591556, 0.0397659, 0.0205128, 0.00143964, -0.0174121, -0.036003, -0.0542955, -0.0722537, -0.0898438, -0.107033, -0.123792, -0.140091, -0.155904, -0.171205, -0.185971, -0.200179, -0.213809, -0.226843, -0.239262, -0.251051, -0.262196, -0.272684, -0.282504, -0.291645, -0.300098, -0.307857, -0.314916, -0.321269, -0.326914, -0.331847, -0.336069, -0.339579, -0.342378, -0.34447, -0.345857, -0.346545, -0.346538, -0.345845, -0.344471, -0.342427, -0.339722, -0.336365, -0.33237, -0.327747, -0.32251, -0.316673, -0.31025, -0.303257, -0.295709, -0.287625, -0.27902, -0.269913, -0.260324, -0.25027, -0.239772, -0.22885, -0.217525, -0.205819, -0.193753, -0.181348, -0.168628, -0.155616, -0.142335, -0.128808, -0.115059, -0.101112, -0.0869912, -0.0727214, -0.058327, -0.0438327, -0.0292635, -0.0146443, 0, 0.0146443, 0.0292635, 0.0438327, 0.058327, 0.0727214, 0.0869912, 0.101112, 0.115059, 0.128808, 0.142335, 0.155616, 0.168628, 0.181348, 0.193753, 0.205819, 0.217525, 0.22885, 0.239772, 0.25027, 0.260324, 0.269913, 0.27902, 0.287625, 0.295709, 0.303257, 0.31025, 0.316673, 0.32251, 0.327747, 0.33237, 0.336365, 0.339722, 0.342427, 0.344471, 0.345845, 0.346538, 0.346545, 0.345857, 0.34447, 0.342378, 0.339579, 0.336069, 0.331847, 0.326914, 0.321269, 0.314916, 0.307857, 0.300098, 0.291645, 0.282504, 0.272684, 0.262196, 0.251051, 0.239262, 0.226843, 0.213809, 0.200179, 0.185971, 0.171205, 0.155904, 0.140091, 0.123792, 0.107033, 0.0898438, 0.0722537, 0.0542955, 0.036003, 0.0174121, -0.00143964, -0.0205128, -0.0397659, -0.0591556, -0.0786367, -0.0981618, -0.117682, -0.137146, -0.156499, -0.175688, -0.194654, -0.213337, -0.231676, -0.249606, -0.267062, -0.283974, -0.300272, -0.315883, -0.33073, -0.344737, -0.357823, -0.369906, -0.380899, -0.390717, -0.399268, -0.406459, -0.412197, -0.416382, -0.418915, -0.419692, -0.418608, -0.415555, -0.410421, -0.403092, -0.393452, -0.381382, -0.366758, -0.349457, -0.329349, -0.306305, -0.280189, -0.250866, -0.218195, -0.182034, -0.142236, -0.0986524, -0.0511315, 0.00048213, 0.056347, 0.116625, 0.18148, 0.251082, 0.3256, 0.40521, 0.49009, 0.580421, 0.676387, 0.778178, 0.885983, 1, 1, 0.842246, 0.69672, 0.562846, 0.440066, 0.327838, 0.22564, 0.132961, 0.049309, -0.0257927, -0.0928064, -0.152179, -0.204343, -0.249715, -0.2887, -0.321688, -0.349055, -0.371163, -0.388362, -0.40099, -0.409371, -0.413817, -0.414628, -0.412093, -0.406489, -0.39808, -0.387123, -0.37386, -0.358526, -0.341342, -0.322522, -0.302269, -0.280777, -0.258229, -0.234801, -0.210659, -0.185961, -0.160854, -0.13548, -0.109973, -0.0844555, -0.0590462, -0.0338548, -0.00898385, 0.0154707, 0.03942, 0.0627818, 0.0854799, 0.107445, 0.128612, 0.148924, 0.168328, 0.186778, 0.204231, 0.220651, 0.236007, 0.25027, 0.263419, 0.275436, 0.286306, 0.296019, 0.30457, 0.311956, 0.318179, 0.323242, 0.327154, 0.329926, 0.331571, 0.332106, 0.33155, 0.329925, 0.327256, 0.323567, 0.318889, 0.31325, 0.306684, 0.299224, 0.290905, 0.281765, 0.271841, 0.261173, 0.249801, 0.237767, 0.225112, 0.21188, 0.198115, 0.18386, 0.16916, 0.15406, 0.138606, 0.122841, 0.106812, 0.0905639, 0.0741416, 0.05759, 0.0409537, 0.0242767, 0.00760288, -0.00902475, -0.0255637, -0.0419721, -0.058209, -0.0742341, -0.0900081, -0.105493, -0.120651, -0.135446, -0.149842, -0.163807, -0.177307, -0.190311, -0.202789, -0.214712, -0.226053, -0.236786, -0.246887, -0.256333, -0.265102, -0.273176, -0.280535, -0.287165, -0.293049, -0.298175, -0.302532, -0.30611, -0.308901, -0.310899, -0.3121, -0.3125, -0.3121, -0.310899, -0.308901, -0.30611, -0.302532, -0.298175, -0.293049, -0.287165, -0.280535, -0.273176, -0.265102, -0.256333, -0.246887, -0.236786, -0.226053, -0.214712, -0.202789, -0.190311, -0.177307, -0.163807, -0.149842, -0.135446, -0.120651, -0.105493, -0.0900081, -0.0742341, -0.058209, -0.0419721, -0.0255637, -0.00902475, 0.00760288, 0.0242767, 0.0409537, 0.05759, 0.0741416, 0.0905639, 0.106812, 0.122841, 0.138606, 0.15406, 0.16916, 0.18386, 0.198115, 0.21188, 0.225112, 0.237767, 0.249801, 0.261173, 0.271841, 0.281765, 0.290905, 0.299224, 0.306684, 0.31325, 0.318889, 0.323567, 0.327256, 0.329925, 0.33155, 0.332106, 0.331571, 0.329926, 0.327154, 0.323242, 0.318179, 0.311956, 0.30457, 0.296019, 0.286306, 0.275436, 0.263419, 0.25027, 0.236007, 0.220651, 0.204231, 0.186778, 0.168328, 0.148924, 0.128612, 0.107445, 0.0854799, 0.0627818, 0.03942, 0.0154707, -0.00898385, -0.0338548, -0.0590462, -0.0844555, -0.109973, -0.13548, -0.160854, -0.185961, -0.210659, -0.234801, -0.258229, -0.280777, -0.302269, -0.322522, -0.341342, -0.358526, -0.37386, -0.387123, -0.39808, -0.406489, -0.412093, -0.414628, -0.413817, -0.409371, -0.40099, -0.388362, -0.371163, -0.349055, -0.321688, -0.2887, -0.249715, -0.204343, -0.152179, -0.0928064, -0.0257927, 0.049309, 0.132961, 0.22564, 0.327838, 0.440066, 0.562846, 0.69672, 0.842246, 1
};
 
const float LegendrePolynomial::mNorm[7] = {
1.41421,  0.816497,  0.632456,  0.534522,  0.471405,  0.426401,  0.392232
};

const float LegendrePolynomial::mNorm2[7] = {
2,  0.666667,  0.4,  0.285714,  0.222222,  0.181818,  0.153846
};

LegendrePolynomial::LegendrePolynomial() 
{}

void LegendrePolynomial::sample(int m, int n, float * v,
							float a, float b)
{
	const float dx = (b - a) / (m - 1);
  int i, j;

  for ( i = 0; i < m; i++ )
  {
    v[i+0*m] = 1.0;
  }
  
  for ( i = 0; i < m; i++ )
  {
    v[i+1*m] = (a + dx * i);
  }
 
  for ( j = 2; j <= n; j++ )
  {
	for ( i = 0; i < m; i++ )
    {
      v[i+j*m] = ( ( float ) ( 2 * j - 1 ) *  (a + dx * i) * v[i+(j-1)*m]   
                 - ( float ) (     j - 1 ) *        v[i+(j-2)*m] ) 
                 / ( float ) (     j     );
    }
  }
}

float LegendrePolynomial::P(int l, const float & x)
{
	const float * vl = &mV[l*257];
	const float gx = (x + 1.f) / 2.f * 256;
/// out-of-bound
	if(gx < 0)	return vl[0];
	if(gx >= 256) return vl[256];
	
	const int g0 = gx;
	const int g1 = g0+1;
	const float alpha = gx - g0;
	if(alpha < 1e-3f) return vl[g0];
	
	return vl[g0] * (1.f - alpha) + vl[g1] * alpha; 

}

float LegendrePolynomial::norm(int i)
{ return mNorm[i]; }

float LegendrePolynomial::norm2(int i)
{ return mNorm2[i]; }

float LegendrePolynomial::Pn(int l, const float & x)
{ return P(l, x) / mNorm[l]; }


float * upsample(int & ny, const float * x, const int & n, 
				const int & p, const int & phase)
{
	ny = n * p;
	float * y = new float[ny];
	int i=0, j;
	for(;i<n;++i) {
		for(j=0;j<p;++j) {
			if(j==phase) 
				y[i*p+j] = x[i];
			else
				y[i*p+j] = 0.f;
		}
	}
	
	return y;
}

float * downsample(int & ny, const float * x, const int & n, 
				const int & p, const int & phase)
{
	int i=0, j=0;
	for(;i<n;++i) {
		if(i== j*p + phase) {
			j++;
		}
	}
	
	ny = j;
	
	float * y = new float[ny];
	
	i=j=0;
	for(;i<n;++i) {
		if(i== j*p + phase) {
			y[j++]=x[i];
		}
	}
	
	return y;
}

int periodic(const int & i, const int & n)
{
	if(i<0)
		return n+i;
	if(i>n-1)
		return i-n;
	return i;
}

float * circshift(const float * x, const int & n, const int & p)
{
	float * y = new float[n];
	int i=0;
	for(;i<n;++i) {
		y[i] = x[periodic(i+p, n)];
	}
	return y;
}

/// http://learn.mikroe.com/ebooks/digitalfilterdesign/chapter/window-functions/
/// 1D impulse response from binomial weights
/// [1, 4, 6, 4, 1]/16
/// 2D approximation
/// [1  4  7  4 1]
/// [4 16 26 16 4]
/// [7 26 41 26 7]
/// [4 16 26 16 4]
/// [1  4  7  4 1]/273
/// finite impulse response express each output sample as a weighted sum of the last N input samples
/// y[n] = b0x[n] + b1x[n-1] + ... + bNx[n-N]
///      = sigma (i=0,N) bi x[n-i]
/// y[n] input signal
/// x[n] output signal
/// N filter order

float * fir(const float * x, const int & n,
			const float * w, const int & m)
{
	float * y = new float[n];
	
	int i=0, j;
	for(;i<n;++i) {
		y[i] = 0.f;
		
		for(j=0; j<m;++j) {
			y[i] += w[j] * x[periodic(i-j, n)];
		}
	}
	
	return y;
}

/// http://learn.mikroe.com/ebooks/digitalfilterdesign/chapter/examples/
static const float HANNW10[11] = {
-.045016, 0., .075026, .159155, .225079,
.25,
.225079, .159155, .075026, 0., -.045016};

float * firlHann(const float * x, const int & n)
{
	float * y = new float[n];
	
	int i=0, j;
	for(;i<n;++i) {
		y[i] = 0.f;
		
		for(j=0; j<11;++j) {
			y[i] += HANNW10[10-j] * x[periodic(i-j, n)];
		}
	}
	
	return y;
}

}

UniformPlot2D::UniformPlot2D() :
m_numY(0),
m_y(NULL)
{}

UniformPlot2D::~UniformPlot2D()
{
	if(m_numY) delete[] m_y;
}

void UniformPlot2D::create(const int & n)
{
	if(m_numY >= n) {
		m_numY = n;
		return;
	}
	
	if(m_numY) delete[] m_y;
	m_numY = n;
	m_y = new float[n];
}

void UniformPlot2D::create(const float * y, const int & n)
{
	create(n);
	for(int i=0;i<n;++i)
		m_y[i] = y[i];
}

void UniformPlot2D::setColor(float r, float g, float b)
{ m_color.set(r,g,b); }

const Vector3F & UniformPlot2D::color() const
{ return m_color; }

const float * UniformPlot2D::y() const
{ return m_y; }

float * UniformPlot2D::y()
{ return m_y; }

const int & UniformPlot2D::numY() const
{ return m_numY; }

}
